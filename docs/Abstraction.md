# Vensim PLE相当システムダイナミクス モデリング ツール 実装プラン

## 基本情報
- **作成日**: 2025年8月31日
- **バージョン**: 2.0
- **最終更新**: 2025年8月31日（構造化リファクタリング完了）
- **想定実装期間**: 14週間（約3.5ヶ月）
- **対象技術スタック**: Next.js 15.5.2 + TypeScript + Tailwind CSS v4

---

## 1. プロジェクト概要

### 1.1 目的
Vensim PLEに相当するシステムダイナミクスモデリングツールの開発

### 1.2 対象ユーザー
- システムダイナミクス学習者
- 研究者・教育者
- ビジネスアナリスト
- 政策立案者

### 1.3 機能制限（Vensim PLE相当）
- モデルサイズ制限（変数数、ストック数）
- 高度な分析機能の制限
- データ連携機能の簡素化

---

## 2. 機能要件

### 2.1 因果ループ図（Causal Loop Diagrams）
- 変数間の因果関係を矢印で表現
- 正の関係（+）と負の関係（-）の表示
- ループの識別と表示
- テキストラベルとコメントの追加

### 2.2 ストック・フロー図（Stock and Flow Diagrams）
- ストック（蓄積量）: 四角形で表現
- フロー（流量）: パイプと蛇口アイコンで表現
- 雲（Cloud）: システム境界を表現
- コネクタ: 情報リンク
- 補助変数: 円形で表現

### 2.3 モデリング機能
- ドラッグ&ドロップによる図表作成
- 要素の選択、移動、サイズ変更
- 接続線の自動/手動描画
- グループ化と階層表示
- 方程式エディタ

### 2.4 シミュレーション機能
- 時間設定（開始時間、終了時間、時間単位）
- 統合手法の選択（Euler、Runge-Kutta等）
- パラメータ値の設定と変更
- シミュレーション実行
- リアルタイム結果表示

### 2.5 分析・可視化機能
- グラフ表示（時系列、XY散布図）
- テーブル表示
- 複数変数の同時表示
- データエクスポート
- 感度分析（基本機能）

---

## 3. 技術アーキテクチャ

### 3.1 確定技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 15.5.2（既存）
- **言語**: TypeScript（既存）
- **スタイリング**: Tailwind CSS v4（既存）
- **状態管理**: Zustand（統合ストア方式）
- **図表描画**: Konva.js + React-Konva v19.0.0
- **数値計算**: Math.js
- **グラフ描画**: Recharts
- **ファイル処理**: File API
- **数式表示**: KaTeX

#### 開発ツール
- **既存**: Biome（linting/formatting）
- **テスト**: Vitest + React Testing Library
- **E2E**: Playwright

### 3.2 最終ライブラリ構成
```json
{
  "zustand": "^5.0.1",
  "konva": "^9.3.12",
  "react-konva": "^19.0.0",
  "mathjs": "^13.2.2",
  "recharts": "^2.12.7",
  "katex": "^0.16.11",
  "react-katex": "^3.0.1"
}
```

### 3.3 アーキテクチャ設計決定事項

#### 状態管理
- **統合diagram-store**: 因果ループ図・ストック・フロー図を一元管理
- **App Router間共有**: グローバルストアによる3ページ間での状態共有

#### パフォーマンス対策
- **検証目標**: 1000要素で60fps維持
- **テストケース**: 1000ノードの単方向ループ（円形配置、順次接続）
- **代替案**: パフォーマンス不足時は自作キャンバスエンジン検討

#### その他技術判断
- **アンドゥ/リドゥ**: 操作単位（コマンドパターン）で実装
- **数値計算**: Phase 5で詳細決定、図表作成を優先
- **外部互換性**: Vensim PLEとの互換性は考慮せず独自JSONフォーマット
- **チュートリアル**: 実装対象外（MVP重視）

---

## 4. 実装計画

### Phase 1: 基盤構築（Week 1-2）
1. **最適化されたライブラリ追加**
2. **基本レイアウトとナビゲーション**
3. **Konva.jsパフォーマンス検証プロトタイプ作成**
4. **統合状態管理システム実装**
5. **操作単位アンドゥ/リドゥ基盤構築**
6. **図表描画基盤の構築**

### Phase 2: 因果ループ図機能（Week 3-4）
1. キャンバスコンポーネントの実装
2. 変数ノードの作成・編集・削除
3. 矢印（因果関係）の描画と編集
4. 極性（+/-）の表示と編集
5. テキストラベルとコメント機能

### Phase 3: ストック・フロー図機能（Week 5-6）
1. ストック要素の実装
2. フロー要素の実装
3. 雲（境界）要素の実装
4. コネクタの実装
5. 補助変数の実装

### Phase 4: 方程式エディタ（Week 7）
1. 方程式入力インターフェース
2. 数式解析とバリデーション
3. 変数間の依存関係チェック
4. 数式表示機能

### Phase 5: シミュレーション機能（Week 8-9）
1. 数値積分エンジンの実装
2. シミュレーション設定UI
3. 実行制御（開始/停止/リセット）
4. 進捗表示と結果更新

### Phase 6: 分析・可視化機能（Week 10-11）
1. グラフ表示コンポーネント
2. データテーブル表示
3. 複数変数の同時表示
4. データエクスポート機能

### Phase 7: ファイル管理（Week 12）
1. モデルの保存・読み込み
2. JSONフォーマット定義
3. インポート/エクスポート機能
4. 最近使用したファイル管理

### Phase 8: テスト・最適化（Week 13-14）
1. 単体テスト実装
2. 統合テスト実装
3. パフォーマンス最適化
4. UI/UXの改善

---

## 5. ファイル構造

```
src/
├── app/
│   ├── layout.tsx                  # 既存
│   ├── page.tsx                    # 既存 - ダッシュボード
│   ├── globals.css                 # 既存 + カスタムスタイル
│   ├── causal-loop/
│   │   └── page.tsx               # 因果ループ図エディタ
│   ├── stock-flow/
│   │   └── page.tsx               # ストック・フロー図エディタ
│   └── analysis/
│       └── page.tsx               # 分析・グラフ表示
├── components/
│   ├── ui/                        # 基本UIコンポーネント
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── modal.tsx
│   │   ├── toolbar.tsx
│   │   └── sidebar.tsx
│   ├── canvas/                    # キャンバス関連
│   │   ├── canvas.tsx
│   │   ├── canvas-container.tsx
│   │   └── canvas-grid.tsx
│   ├── diagram/                   # 図表要素
│   │   ├── causal-loop/
│   │   │   ├── variable-node.tsx
│   │   │   ├── causal-link.tsx
│   │   │   └── causal-loop-editor.tsx
│   │   └── stock-flow/
│   │       ├── stock.tsx
│   │       ├── flow.tsx
│   │       ├── cloud.tsx
│   │       ├── auxiliary.tsx
│   │       ├── connector.tsx
│   │       └── stock-flow-editor.tsx
│   ├── equation/                  # 方程式関連
│   │   ├── equation-editor.tsx
│   │   ├── equation-display.tsx
│   │   └── variable-inspector.tsx
│   ├── simulation/                # シミュレーション関連
│   │   ├── simulation-panel.tsx
│   │   ├── simulation-controls.tsx
│   │   └── simulation-settings.tsx
│   ├── analysis/                  # 分析・可視化
│   │   ├── graph-panel.tsx
│   │   ├── data-table.tsx
│   │   ├── time-series-chart.tsx
│   │   └── scatter-plot.tsx
│   └── file/                      # ファイル管理
│       ├── file-manager.tsx
│       ├── save-dialog.tsx
│       └── load-dialog.tsx
├── lib/
│   ├── stores/                    # 状態管理
│   │   ├── diagram-store.ts       # 統合図表管理
│   │   ├── simulation-store.ts    # シミュレーション関連
│   │   ├── ui-store.ts           # UI状態管理
│   │   └── file-store.ts         # ファイル管理
│   ├── types/                     # 型定義
│   │   ├── diagram.ts
│   │   ├── simulation.ts
│   │   └── file.ts
│   ├── utils/                     # ユーティリティ
│   │   ├── math.ts
│   │   ├── geometry.ts
│   │   ├── validation.ts
│   │   └── export.ts
│   ├── engines/                   # コアエンジン
│   │   ├── simulation-engine.ts
│   │   ├── equation-parser.ts
│   │   └── dependency-analyzer.ts
│   └── constants/
│       ├── defaults.ts
│       └── config.ts
└── styles/
    ├── canvas.css                 # キャンバス専用スタイル
    └── components.css             # コンポーネント専用スタイル
```

---

## 6. 品質管理

### 6.1 テスト戦略

#### 単体テスト
- **対象**: 全コンポーネント、ユーティリティ関数、ストア
- **フレームワーク**: Jest + React Testing Library
- **カバレッジ目標**: 80%以上

#### 統合テスト
- **対象**: コンポーネント間の連携、データフロー
- **重点領域**: 図表作成ワークフロー、シミュレーション実行プロセス、ファイル保存・読み込み

#### E2Eテスト
- **フレームワーク**: Playwright
- **シナリオ**: 因果ループ図の作成から実行まで、ストック・フロー図の作成から分析まで、ファイル操作の完全なワークフロー

#### パフォーマンステスト
- **対象**: 大規模モデルの描画性能、シミュレーション実行時間、メモリ使用量

#### ユーザビリティテスト
- **対象ユーザー**: システムダイナミクス初学者〜中級者
- **評価項目**: 操作の直感性、学習しやすさ、エラーメッセージの分かりやすさ

### 6.2 成功指標

#### 技術指標
- **パフォーマンス**: 1000要素のモデルで60fps維持
- **信頼性**: シミュレーション結果の数値精度 99.9%
- **テストカバレッジ**: 80%以上
- **バグ密度**: 1件/1000行未満

#### ユーザビリティ指標
- **学習時間**: 基本操作習得まで30分以内
- **タスク成功率**: 一般的なモデル作成タスク 95%以上
- **ユーザー満足度**: NPS（Net Promoter Score） 50以上

#### 教育効果指標
- **理解度向上**: システムダイナミクス概念の理解度 20%向上
- **モデル品質**: 作成されたモデルの論理的整合性
- **継続使用率**: 3ヶ月後の継続使用率 70%以上

---

## 7. リスク管理

### 7.1 技術リスク

#### Canvas描画のパフォーマンス問題
- **対策**: Phase 1での早期検証、段階的最適化、WebGL利用検討、自作キャンバスエンジンの代替案準備

#### 数値計算の精度・安定性
- **対策**: 十分なテスト、既存ライブラリの活用（後回し戦略により初期リスク軽減）

#### ブラウザ互換性問題
- **対策**: モダンブラウザ対象、Polyfill活用

### 7.2 ユーザビリティリスク

#### 複雑なUIによる学習コスト増大
- **対策**: 段階的機能公開、充実したドキュメント

#### システムダイナミクス概念の理解困難
- **対策**: 詳細なドキュメント、サンプルモデル提供

### 7.3 プロジェクトリスク

#### 開発期間の延長
- **対策**: 段階的リリース、MVP重視

#### リソース不足
- **対策**: 優先度明確化、外部ライブラリ活用

---

## 8. 設計原則・考慮事項

### 8.1 パフォーマンス
- **Canvas最適化**: Konva.jsの描画最適化、レイヤー分割
- **状態管理**: 不要な再レンダリングの防止、メモ化の活用
- **数値計算**: WebWorkerでの並列処理検討
- **メモリ管理**: 大規模モデルでのメモリリーク対策

### 8.2 ユーザビリティ
- **レスポンシブデザイン**: タブレット対応（モバイルは対象外）
- **アクセシビリティ**: キーボードナビゲーション、スクリーンリーダー対応
- **国際化**: 日本語・英語対応の準備
- **オフライン対応**: PWA機能の検討

### 8.3 データ整合性
- **モデル検証**: 循環参照、未定義変数の検出
- **型安全性**: TypeScript型定義の徹底
- **バックアップ**: 自動保存機能の実装
- **バージョン管理**: モデルファイルの互換性維持

### 8.4 コード品質
- **Biome設定**: 既存の設定を活用、必要に応じて調整
- **コンポーネント設計**: 単一責任の原則、再利用性重視
- **命名規則**: 一貫した命名規則の採用
- **ドキュメント**: JSDOCによる関数・クラスの文書化

### 8.5 セキュリティ
- **ファイルアップロード**: サイズ制限、形式チェック
- **XSS対策**: ユーザー入力の適切なサニタイゼーション
- **CSP**: Content Security Policyの設定

### 8.6 教育的配慮

#### 学習支援機能
- **サンプルモデル**: 学習用の基本モデル提供
- **ヘルプシステム**: コンテキスト依存ヘルプ
- **エラー説明**: 分かりやすいエラーメッセージ

#### 教育機関向け機能（将来拡張）
- **クラス管理**: 複数生徒のモデル管理
- **課題テンプレート**: 授業用テンプレート
- **進捗追跡**: 学習進捗の可視化

---

## 9. 将来拡張可能性

### 9.1 機能拡張
- **協調機能**: リアルタイム共同編集
- **AI支援**: モデル作成支援、最適化提案
- **高度な分析**: 感度分析、最適化機能
- **データ連携**: 外部データソース連携

### 9.2 プラットフォーム拡張
- **モバイルアプリ**: React Native版
- **デスクトップアプリ**: Electron版
- **クラウド版**: マルチテナント対応

### 9.3 教育機関向け拡張
- **LMS連携**: Moodle、Canvas等との連携
- **評価機能**: 自動採点、評価レポート
- **管理機能**: 学生・課題管理システム

---

## 10. 実装方針

### 10.1 段階的実装アプローチ
- MVP（最小限の価値のある製品）を優先
- 複雑な機能は後回し
- ユーザーフィードバックを早期に取得

### 10.2 除外された機能
- **lodash, uuid**: バンドルサイズ削減のため除外
- **チュートリアル機能**: MVP重視のため実装対象外
- **Vensim PLE互換性**: 開発工数削減のため考慮せず

### 10.3 実装開始準備完了
すべての技術仕様と実装方針が確定し、Phase 1 の実装開始準備が完了しました。